<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><TITLE>vigra - graph_agglomerative_clustering.cxx</TITLE>
<link rel=stylesheet type="text/css" href="vigra.css">
<link rel=stylesheet type="text/css" href="vigra_1_8_2.css">
<link rel="shortcut icon" href="vigra-icon.ico" />
<script type="text/javascript">
function toggleHiddenDocumentation( textID, toggleID, toggleMessage )
{
	if( document.getElementById(textID).style.display == 'none' )
    {
		document.getElementById(textID).style.display = 'block';
        document.getElementById(toggleID).innerHTML = "hide " + toggleMessage;
    }
    else
    {
		document.getElementById(textID).style.display = 'none';
        document.getElementById(toggleID).innerHTML = "show " + toggleMessage;
	}
    return false;
}
</script>
<script>
var runOnLoad=function(c,o,d,e){function x(){for(e=1;c.length;)c.shift()()}o[d]?(document[d]('DOMContentLoaded',x,0),o[d]('load',x,0)):o.attachEvent('onload',x);return function(t){e?o.setTimeout(t,0):c.push(t)}}([],window,'addEventListener');
</script>
<script type="text/javascript" src="documents/CollapsibleLists.js"></script>
<script type="text/javascript">
    runOnLoad(function(){ CollapsibleLists.apply(); });
</script>
<style type="text/css">
.collapsibleList li.collapsibleListOpen{
  list-style-image:url('documents/pfeil.gif');
  cursor:pointer;
}
.collapsibleList li.collapsibleListClosed{
  list-style-image:url('documents/bullet.gif');
  cursor:pointer;
}
.collapsibleList li.lastItem{
  list-style-image:url('documents/diamond.gif');
}
</style>
</head>
<body  bgcolor="#f8f0e0" link="#0040b0" vlink="#a00040">
<basefont face="Helvetica,Arial,sans-serif" size=3>
<p align=right>
[ <a href="http://ukoethe.github.io/vigra/">VIGRA Homepage</a> |
 <a href="functionindex.html">Function Index</a> |
 <a href="classes.html">Class Index</a> |
 <a href="namespaces.html">Namespaces</a> |
 <a href="files.html">File List</a> |
 <a href="index.html">Main Page</a> ]
</p>
<!-- Generated by Doxygen 1.8.6 -->
</div><!-- top -->
<div class="contents">
<table class="main_heading">
<tr>
<td width="100%">graph_agglomerative_clustering.cxx
</td>
<td align=right><a href="http://hci.iwr.uni-heidelberg.de/vigra/"><IMG border=0 ALT="VIGRA" SRC="documents/vigra.gif" title="VIGRA Homepage"></a></td></tr>
</table><p>

<p>Segment an image by hierarchical clustering on top of watershed superpixels <br/>
 Usage: <code>subimage_tutorial infile outfile</code></p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;vigra/multi_array.hxx&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="impex_8hxx.html">vigra/impex.hxx</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vigra/multi_resize.hxx&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vigra/colorconversions.hxx&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vigra/multi_convolution.hxx&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vigra/multi_watersheds.hxx&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vigra/multi_gridgraph.hxx&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vigra/accumulator.hxx&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vigra/adjacency_list_graph.hxx&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vigra/graph_algorithms.hxx&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vigra/hierarchical_clustering.hxx&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vigra/metrics.hxx&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">using namespace </span>vigra;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// parameters of the hierarchical clustering algorithm</span></div>
<div class="line">    <span class="keywordtype">float</span> sigmaGradMag = 3.0f;   <span class="comment">// scale of the Gaussian gradient</span></div>
<div class="line">    <span class="keywordtype">float</span> beta = 0.5f;           <span class="comment">// importance of node features relative to edge weights</span></div>
<div class="line">    <span class="keywordtype">float</span> wardness = 0.8f;       <span class="comment">// importance of cluster size</span></div>
<div class="line">    <span class="keywordtype">int</span> numClusters = 30;        <span class="comment">// desired number of resulting regions (clusters)</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>(argc != 3)</div>
<div class="line">    {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Usage: &quot;</span> &lt;&lt; argv[0] &lt;&lt; <span class="stringliteral">&quot; infile outfile&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;(supported formats: &quot;</span> &lt;&lt; <a name="a0"></a><a class="code" href="group__VigraImpex.html#ga1f42a533f86021968b8ca4d9d9644279">impexListFormats</a>() &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;(only color images)&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// read metadata of image file given in argv[1]</span></div>
<div class="line">        <a name="_a1"></a><a class="code" href="classvigra_1_1ImageImportInfo.html">ImageImportInfo</a> info(argv[1]);</div>
<div class="line"></div>
<div class="line">        vigra_precondition(info.<a name="a2"></a><a class="code" href="classvigra_1_1ImageImportInfo.html#a62ce27eb9300cb7ad1ad4fbc32ad6db8">numBands</a>() == 3, <span class="stringliteral">&quot;an RGB image is required.&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// instantiate image arrays of appropriate size</span></div>
<div class="line">        <a name="_a3"></a><a class="code" href="classvigra_1_1MultiArray.html">MultiArray&lt;2, TinyVector&lt;float, 3&gt;</a> &gt; imageArrayRGB(info.<a name="a4"></a><a class="code" href="classvigra_1_1ImageImportInfo.html#a2ff3a7aba044197e8bc713d86b2d775b">shape</a>()),</div>
<div class="line">                                             imageArrayLab(info.<a class="code" href="classvigra_1_1ImageImportInfo.html#a2ff3a7aba044197e8bc713d86b2d775b">shape</a>());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// read image data</span></div>
<div class="line">        <a name="a5"></a><a class="code" href="group__VigraImpex.html#ga01aca6d5278dab14e11aef62e746e63e">importImage</a>(info, imageArrayRGB);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// convert to Lab color space for better color similarity estimates</span></div>
<div class="line">        <a name="a6"></a><a class="code" href="group__MultiPointoperators.html#ga4e3f906de480f4a867340968da8a98dd">transformMultiArray</a>(imageArrayRGB, imageArrayLab, <a name="_a7"></a><a class="code" href="classvigra_1_1RGB2LabFunctor.html">RGB2LabFunctor&lt;float&gt;</a>());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// compute gradient magnitude as an indicator of edge strength</span></div>
<div class="line">        <a class="code" href="classvigra_1_1MultiArray.html">MultiArray&lt;2, float&gt;</a>   gradMag(imageArrayLab.shape());</div>
<div class="line">        <a name="a8"></a><a class="code" href="group__ConvolutionFilters.html#gab80e356fa487f97d718ed815a3cf4855">gaussianGradientMagnitude</a>(imageArrayLab, gradMag, sigmaGradMag);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// create watershed superpixels with the fast union-find algorithm;</span></div>
<div class="line">        <span class="comment">// we use a NodeMap (a subclass of MultiArray) to store the labels so</span></div>
<div class="line">        <span class="comment">// that they can be passed to hierarchicalClustering() directly</span></div>
<div class="line">        <a class="code" href="classvigra_1_1MultiArray.html">MultiArray&lt;2, unsigned int&gt;</a> labelArray(gradMag.shape());</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_label =</div>
<div class="line">            <a name="a9"></a><a class="code" href="group__Superpixels.html#ga67dae5f2292e59d2de0936e7aa4f3e67">watershedsMultiArray</a>(gradMag, labelArray, <a name="a10"></a><a class="code" href="group__MultiIteratorGroup.html#gga9d75de3edc093f215c3f4d42a966167aaf5b533c53c0491107c6c9b890b635372">DirectNeighborhood</a>,</div>
<div class="line">                                 <a name="_a11"></a><a class="code" href="classvigra_1_1WatershedOptions.html">WatershedOptions</a>().unionFind());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// double the image resolution for better visualization of the results</span></div>
<div class="line">        <a class="code" href="classvigra_1_1MultiArray.html">MultiArray&lt;2, TinyVector&lt;float, 3&gt;</a> &gt; imageArrayBig(info.<a class="code" href="classvigra_1_1ImageImportInfo.html#a2ff3a7aba044197e8bc713d86b2d775b">shape</a>()*2-Shape2(1));</div>
<div class="line">        <a name="a12"></a><a class="code" href="group__GeometricTransformations.html#ga2cd9b31e7f0c8648bc0d9e1a8f1a3305">resizeMultiArraySplineInterpolation</a>(imageArrayRGB, imageArrayBig);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// visualize the watersheds as a red overlay over the enlarged image</span></div>
<div class="line">        <a name="a13"></a><a class="code" href="group__Labeling.html#ga0d13d25c5b735aaca90c5a506bb274ac">regionImageToCrackEdgeImage</a>(labelArray, imageArrayBig,</div>
<div class="line">                                    <a name="_a14"></a><a class="code" href="classvigra_1_1RGBValue.html">RGBValue&lt;float&gt;</a>( 255, 0, 0 ), EdgeOverlayOnly);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// create grid-graph of appropriate size</span></div>
<div class="line">        <span class="keyword">typedef</span> <a name="_a15"></a><a class="code" href="classvigra_1_1GridGraph.html">GridGraph&lt;2, undirected_tag &gt;</a> ImageGraph;</div>
<div class="line">        ImageGraph imageGraph(labelArray.shape());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// construct empty  region adjacency graph (RAG) for the superpixels</span></div>
<div class="line">        <span class="keyword">typedef</span> <a name="_a16"></a><a class="code" href="classvigra_1_1AdjacencyListGraph.html">AdjacencyListGraph</a> RAG;</div>
<div class="line">        RAG rag;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// create mapping &#39;affiliatedEdges&#39; from edges in the RAG to</span></div>
<div class="line">        <span class="comment">// corresponding edges in imageGraph and build the RAG</span></div>
<div class="line">        RAG::EdgeMap&lt;std::vector&lt;ImageGraph::Edge&gt;&gt; affiliatedEdges(rag);</div>
<div class="line">        <a name="a17"></a><a class="code" href="group__GraphDataStructures.html#gac2e4a082419162804528250e835f0b0f">makeRegionAdjacencyGraph</a>(imageGraph, labelArray, rag, affiliatedEdges);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// create edge maps for weights and lengths of the RAG edges (zero initialized)</span></div>
<div class="line">        RAG::EdgeMap&lt;float&gt; edgeWeights(rag),</div>
<div class="line">                            edgeLengths(rag);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// iterate over all RAG edges (this loop follows a standard LEMON idiom)</span></div>
<div class="line">        <span class="keywordflow">for</span>(RAG::EdgeIt rag_edge(rag); rag_edge != lemon::INVALID; ++rag_edge)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// iterate over all grid edges that constitute the present RAG edge</span></div>
<div class="line">            <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; affiliatedEdges[*rag_edge].size(); ++k)</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// look up the current grid edge and its end points</span></div>
<div class="line">                <span class="keyword">auto</span> <span class="keyword">const</span> &amp; grid_edge = affiliatedEdges[*rag_edge][k];</div>
<div class="line">                <span class="keyword">auto</span> start = imageGraph.u(grid_edge),</div>
<div class="line">                     end   = imageGraph.v(grid_edge);</div>
<div class="line"></div>
<div class="line">                <span class="comment">// compute gradient by linear interpolation between end points</span></div>
<div class="line">                <span class="keywordtype">double</span> grid_edge_gradient = 0.5 * (gradMag[start] + gradMag[end]);</div>
<div class="line">                <span class="comment">// aggregate the total</span></div>
<div class="line">                edgeWeights[*rag_edge] += grid_edge_gradient;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// the length of the RAG edge equals the number of constituent grid edges</span></div>
<div class="line">            edgeLengths[*rag_edge] = affiliatedEdges[*rag_edge].size();</div>
<div class="line">            <span class="comment">// define edge weight by the average gradient</span></div>
<div class="line">            edgeWeights[*rag_edge] /= edgeLengths[*rag_edge];</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// determine size and average color of each superpixel</span></div>
<div class="line">        <span class="keyword">using namespace </span>acc;</div>
<div class="line">        AccumulatorChainArray&lt;CoupledArrays&lt;2, TinyVector&lt;float, 3&gt;, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&gt;,</div>
<div class="line">                              Select&lt;DataArg&lt;1&gt;, LabelArg&lt;2&gt;, <span class="comment">// where to look for data and region labels</span></div>
<div class="line">                                     <a name="a18"></a><a class="code" href="namespacevigra_1_1acc.html#a8b80913ec664dd2e7949b1fef390b144">Count</a>, <a name="a19"></a><a class="code" href="namespacevigra_1_1acc.html#ac0f533874b6415005dcf8974478c4b8e">Mean</a>&gt; &gt;           <span class="comment">// what statistics to compute</span></div>
<div class="line">            features;</div>
<div class="line">        <a name="a20"></a><a class="code" href="namespacevigra_1_1acc.html#a5640bdd147f40fbd9424594ea7a2515c">extractFeatures</a>(imageArrayLab, labelArray, features);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// copy superpixel features into NodeMaps to be passed to hierarchicalClustering()</span></div>
<div class="line">        RAG::NodeMap&lt;TinyVector&lt;float, 3&gt;&gt; meanColor(rag);</div>
<div class="line">        RAG::NodeMap&lt;unsigned int&gt;         regionSize(rag);</div>
<div class="line">        <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k=0; k&lt;=max_label; ++k)</div>
<div class="line">        {</div>
<div class="line">            meanColor[k] = get&lt;Mean&gt;(features, k);</div>
<div class="line">            regionSize[k] = get&lt;Count&gt;(features, k);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// create a node map for the new (clustered) region labels and perform</span></div>
<div class="line">        <span class="comment">// clustering to remove unimportant watershed edges</span></div>
<div class="line">        RAG::NodeMap&lt;unsigned int&gt;  nodeLabels(rag);</div>
<div class="line">        <a name="a21"></a><a class="code" href="group__GraphDataStructures.html#gafbaa28685756ee5d69b17c7a31f8b8fb">hierarchicalClustering</a>(rag,          <span class="comment">// input: the superpixel adjacency graph</span></div>
<div class="line">                               edgeWeights, edgeLengths, meanColor, regionSize, <span class="comment">// features</span></div>
<div class="line">                               nodeLabels,   <span class="comment">// output: a cluster labeling of the RAG</span></div>
<div class="line">                               <a name="_a22"></a><a class="code" href="classvigra_1_1ClusteringOptions.html">ClusteringOptions</a>().minRegionCount(numClusters)</div>
<div class="line">                                                  .nodeFeatureImportance(beta)</div>
<div class="line">                                                  .sizeImportance(wardness)</div>
<div class="line">                                                  .nodeFeatureMetric(<a name="a23"></a><a class="code" href="namespacevigra_1_1metrics.html#a5a73aada416b5b8e3f549fb0caf28219adf84137d08f3ca6dc83b921dc7aa8558">metrics::L2Norm</a>)</div>
<div class="line">                               );</div>
<div class="line"></div>
<div class="line">        <span class="comment">// create label image with the new labels</span></div>
<div class="line">        <a class="code" href="group__MultiPointoperators.html#ga4e3f906de480f4a867340968da8a98dd">transformMultiArray</a>(labelArray, labelArray,</div>
<div class="line">            [&amp;nodeLabels](<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> oldlabel)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> nodeLabels[oldlabel];</div>
<div class="line">            });</div>
<div class="line"></div>
<div class="line">        <span class="comment">// visualize the salient edges as a green overlay</span></div>
<div class="line">        <a class="code" href="group__Labeling.html#ga0d13d25c5b735aaca90c5a506bb274ac">regionImageToCrackEdgeImage</a>(labelArray, imageArrayBig,</div>
<div class="line">                                    <a class="code" href="classvigra_1_1RGBValue.html">RGBValue&lt;float&gt;</a>( 0, 255, 0), EdgeOverlayOnly);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// write result into image file given by argv[2]</span></div>
<div class="line">        <a name="a24"></a><a class="code" href="group__VigraImpex.html#gabd7976d498abce467cd17989176133e3">exportImage</a>(imageArrayBig, argv[2]);</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">catch</span> (std::exception &amp; e)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// catch any errors that might have occurred and print their reason</span></div>
<div class="line">        std::cout &lt;&lt; e.what() &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- footer.html -->
<p>
<table border=0 cellspacing=0 width="100%"  bgcolor="#e0d0a0" cellpadding=5>
<tr>
<td>
<p>
<i>&copy; <A HREF="http://hci.iwr.uni-heidelberg.de/people/ukoethe/">Ullrich K&ouml;the</A>     (<A
HREF="mailto:ullrich.koethe@iwr.uni-heidelberg.de">ullrich.koethe@iwr.uni-heidelberg.de</A>)</i> <br>
<i><A HREF="http://hci.iwr.uni-heidelberg.de/">
Heidelberg Collaboratory for Image Processing</a>,
University of Heidelberg, Germany</i>
<td>
<p align=right>
<I>html generated using <A HREF="http://www.doxygen.org">doxygen</A> and <A HREF="http://www.python.org">Python</A></I>
<br>
<i>
vigra 1.11.0 (Thu Mar 17 2016)
</i>
</tr>
</table>
</BODY>
</HTML>
